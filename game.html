<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OrtoFix - Desafio de Acentua√ß√£o</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" type="image/png" href="./static/img/favicon.png">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root {
    --color-primary: #4A90E2;
    --color-primary-dark: #357ABD;
    --color-accent: #50E3C2;
    --color-background: #F4F7FA;
    --color-text-dark: #2c3e50;
    --color-text-light: #8492a6;
    --color-card-bg: #ffffff;
    --color-border: #e2e8f0;
    --color-navbar-bg: #3c6a99;
    }
    body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--color-background);
    color: var(--color-text-dark);
   transition: background-color 0.5s ease, color 0.5s ease;
    }
     .text-dynamic-dark { color: var(--color-text-dark); }
    .text-dynamic-light { color: var(--color-text-light); }
    .navbar-logo { width: 40px; height: auto; }
    .navbar-logo { width: 40px; height: auto; }
    .notification-badge {
    position: absolute; top: 0; right: 0;
    width: 12px; height: 12px; background-color: #EF4444;
    border-radius: 50%; border: 2px solid var(--color-primary-dark);
    animation: pulse 2s infinite cubic-bezier(0.66, 0, 0, 1);
    }
    .text-dynamic-dark { color: var(--color-text-dark); }
    .text-dynamic-light { color: var(--color-text-light); }
    .navbar-logo { width: 40px; height: auto; }
    /* --- COMPONENTES DO TEMA --- */
     /* --- COMPONENTES DO TEMA --- */
    .navbar-theme { background-color: var(--color-navbar-bg); transition: background-color 0.5s ease; }
    .menu-theme { background-color: var(--color-card-bg); transition: background-color 0.5s ease; }
    .menu-item-theme { color: var(--color-text-dark); transition: background-color 0.2s ease, color 0.2s ease; }
    .menu-item-theme:hover { background-color: var(--color-border); }
    .menu-item-active { color: var(--color-primary); background-color: var(--color-border); font-weight: 600; }
    .btn-primary-theme { background-color: var(--color-primary); color: white; transition: background-color 0.2s ease; }
    .btn-primary-theme:hover { background-color: var(--color-primary-dark); }
    .btn-secondary-theme { background-color: var(--color-card-bg); color: var(--color-text-dark); border: 1px solid var(--color-border); transition: all 0.2s ease; }
    .btn-secondary-theme:hover { background-color: var(--color-border); }

    @keyframes pulse {
    0%,100%{transform:scale(.9);box-shadow:0 0 0 0 rgba(239,68,68,.7);}
    50%{transform:scale(1.1);box-shadow:0 0 0 8px rgba(239,68,68,0);}
    }
    /* Anima√ß√£o para elementos que surgem */
    @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
    }
     /* Anima√ß√£o da barra de tempo */
    @keyframes decrease {
        from { width: 100%; }
        to { width: 0%; }
    }
    .timer-bar-inner {
        animation-name: decrease;
        animation-timing-function: linear;
    }
    /* --- ESTILOS DO MASCOTE FLUTUANTE --- */
#mascote-assistente {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 100;
    transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
    transform: translateY(200%);
    opacity: 0;
}
#mascote-assistente.visible {
    transform: translateY(0);
    opacity: 1;
}
#mascote-assistente .mascote-img {
    height: 100px;
    width: auto;
    animation: bobbing 3s ease-in-out infinite;
}
#chat-bubble {
    position: absolute;
    bottom: 84px;
    right: 47px;
    background-color: white;
    padding: 12px 16px;
    border-radius: 12px;
    width: 210px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-size: 14px;
    font-weight: 500;
    color: #3c6a99;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
#chat-bubble.show {
    opacity: 1;
    transform: scale(1);
}
#chat-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px;
    right: 20px;
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid white;
}
@keyframes bobbing {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}
/* --- ESTILOS REFINADOS PARA EFEITO DE ERRO --- */
@keyframes targeted-shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(5px); }
  50% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
  100% { transform: translateX(0); }
}

/* Classe que ser√° aplicada via JavaScript */
.shake-effect {
  animation: targeted-shake 0.3s ease-in-out;
}
#feedback-canvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 2000; /* Z-index alto para ficar sobre todos os elementos */
    pointer-events: none; /* Essencial para permitir cliques nos bot√µes abaixo */
}
/* Bot√£o Principal (para a√ß√µes prim√°rias como "Come√ßar", "Verificar") */
.btn-primary-theme {
    background-color: var(--color-primary);
    color: white;
    transition: background-color 0.2s ease;
}
.btn-primary-theme:hover {
    background-color: var(--color-primary-dark);
}

/* Bot√£o Secund√°rio (para a√ß√µes como "Voltar", "Novas Palavras") */
.btn-secondary-theme {
    background-color: var(--color-card-bg);
    color: var(--color-text-dark);
    border: 1px solid var(--color-border);
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}
.btn-secondary-theme:hover {
    background-color: var(--color-border);
}
.text-dynamic-dark { 
    color: var(--color-text-dark); 
}
.text-dynamic-light { 
    color: var(--color-text-light); 
}
</style>
</head>
<!-- NOVO ELEMENTO CANVAS -->
<canvas id="feedback-canvas"></canvas>
<body class="min-h-screen flex flex-col">

<!-- üîπ NAVBAR -->
<header class="header-nav sticky top-0 z-50">
    <nav class="navbar-theme text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-2 flex justify-between items-center">
        <!-- Menu Principal -->
            <div class="relative">
                <button id="menu-btn" type="button" aria-label="Abrir menu principal" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-menu" class="p-2 rounded-full hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200">
                    <i data-lucide="menu"></i>
                </button>
                <div id="dropdown-menu" class="menu-theme absolute left-0 mt-3 rounded-lg shadow-xl py-2 w-56 hidden z-[60]" role="menu">
    <!-- Itens do menu -->
    <a href="inicio.html" role="menuitem" class="menu-item-active flex items-center gap-3 px-4 py-2">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Painel Principal
    </a>
    <a href="#" role="menuitem" id="sound-btn" class="menu-item-theme flex items-center gap-3 px-4 py-2">
        <i data-lucide="volume-2" class="w-5 h-5"></i> Som
    </a>
    <a href="notificacoes.html" role="menuitem" class="menu-item-theme flex items-center gap-3 px-4 py-2">
        <i data-lucide="bell-ring" class="w-5 h-5"></i> Ver Notifica√ß√µes
    </a>
    <a href="configuracoes.html" role="menuitem" class="menu-item-theme flex items-center gap-3 px-4 py-2">
        <i data-lucide="settings" class="w-5 h-5"></i> Configura√ß√µes
    </a>
    <hr class="my-1" style="border-color: var(--color-border);">
    <!-- O bot√£o Sair mant√©m as cores vermelhas por padr√£o de UX -->
    <a href="./index.html" role="menuitem" class="flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors duration-200">
        <i data-lucide="log-out" class="w-5 h-5"></i> Sair
    </a>
</div>
            </div>

            <!-- Logo -->
            <a href="./index.html" class="mx-auto md:mx-0"> 
                <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="navbar-logo">
            </a>

            <!-- √çcones da Direita: Notifica√ß√µes e Perfil -->
            <div class="flex items-center gap-2">
                <!-- √çcone de Notifica√ß√µes -->
                <div class="relative rounded-full hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200">
                    <button id="notifications-btn" class="p-2 focus:outline-none focus:bg-[#5689b9] rounded-md ">
                        <i data-lucide="bell" class="text-[#e3ebf2]"></i>
                    
                        <span class="notification-badge" id="notification-indicator"></span>
                    </button>
                    <!-- Dropdown de Notifica√ß√µes -->
                    <!-- C√ìDIGO NOVO E CORRIGIDO PARA O DROPDOWN DE NOTIFICA√á√ïES -->
<div id="notifications-dropdown" class="menu-theme absolute right-0 mt-2 w-72 sm:w-80 rounded-lg shadow-xl hidden z-[60] overflow-hidden">
    <!-- Cabe√ßalho do dropdown -->
    <div class="p-3 border-b" style="border-color: var(--color-border);">
        <h3 class="text-sm font-semibold" style="color: var(--color-text-dark);">Notifica√ß√µes Recentes</h3>
    </div>

    <!-- Lista de notifica√ß√µes -->
    <div class="max-h-80 overflow-y-auto">
        <!-- Exemplo 1 -->
        <a href="#" class="menu-item-theme block px-4 py-3">
            <p class="text-sm font-medium">Nova atividade dispon√≠vel!</p>
            <p class="text-xs" style="color: var(--color-text-light);">Jogo de Acentua√ß√£o - N√≠vel M√©dio</p>
        </a>
        <!-- Exemplo 2 -->
        <a href="#" class="menu-item-theme block px-4 py-3">
            <p class="text-sm font-medium">Voc√™ ganhou 50 moedas!</p>
            <p class="text-xs" style="color: var(--color-text-light);">Por completar "Ca√ßa-Palavras Avan√ßado".</p>
        </a>
        <!-- Exemplo 3 (Lida) -->
        <a href="#" class="menu-item-theme block px-4 py-3 opacity-70">
            <p class="text-sm font-medium">Feedback do Professor</p>
            <p class="text-xs" style="color: var(--color-text-light);">Na atividade "Ditado Interativo".</p>
        </a>
    </div>

    <!-- Link para ver todas -->
    <a href="notificacoes.html" class="menu-item-theme block py-2 text-center text-sm border-t" style="border-color: var(--color-border);">
        Ver todas as notifica√ß√µes
    </a>
</div>
                </div>

                <!-- √çcone de Perfil -->
<a href="perfil.html" id="user-avatar-container" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200">
    <!-- O script global-init.js vai inserir o avatar aqui -->
</a>
            </div>
        </div>
    </nav>
</header>

<!-- üîπ CONTE√öDO PRINCIPAL -->
<main class="container mx-auto px-4 py-8 sm:py-12 flex-grow">
    <!-- TELA DO MENU PRINCIPAL -->
    <div id="main-menu">
         <a href="atividades.html" class="inline-flex items-center text-sm font-medium text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors group">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2 transition-transform group-hover:-translate-x-1"></i>
                    Voltar ao Painel
                </a>
        <div class="text-center mb-8 fade-in-up">
            <h1 class="text-4xl md:text-5xl font-bold text-[var(--color-text-dark)] mb-2 tracking-tight">Desafio de Acentua√ß√£o</h1>
            <p class="text-lg text-[var(--color-text-light)] max-w-2xl mx-auto">Escolha um modo de jogo e teste seus conhecimentos!</p>
        </div>
        <div class="flex flex-col sm:flex-row justify-center gap-6">
            <!-- Bot√£o para iniciar o Modo Normal -->
           <button id="start-normal-mode" class="btn-primary-theme px-8 py-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                <span class="text-xl font-bold">Modo Normal</span>
                <p class="font-normal text-sm">Responda sem press√£o de tempo.</p>
            </button>
            <!-- Bot√£o para iniciar o Modo Contra o Tempo -->
            <button id="start-time-attack-mode" class="btn-primary-theme px-8 py-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                <span class="text-xl font-bold">Contra o Tempo</span>
                <p class="font-normal text-sm">Corrida contra o rel√≥gio e vidas limitadas.</p>
            </button>
        </div>
    </div>

    <!-- √ÅREA DO JOGO - MODO NORMAL (ESCONDIDO) -->
    <div id="normal-mode-area" class="hidden max-w-3xl mx-auto">
        <div id="startAreaNormal" class="text-center">
            <div class="mb-6">
    <a href="atividades.html" class="inline-flex items-center text-sm font-medium text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors group">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2 transition-transform group-hover:-translate-x-1"></i>
                    Voltar
                </a>
</div>
<!-- Cabe√ßalho da P√°gina -->
<div class="text-center mb-8 fade-in-up">
    <h1 class="text-4xl md:text-5xl font-bold text-dynamic-dark mb-2 tracking-tight">Desafio de Acentua√ß√£o</h1>
    <p class="text-lg text-dynamic-light max-w-2xl mx-auto">Escolha um modo de jogo e teste seus conhecimentos!</p>
</div>
             
            <button id="btnIniciarNormal" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-105">Come√ßar a Jogar</button>
        </div>
        
        
        <form id="formNormal" class="hidden">
            <a href="inicio.html" class="inline-flex items-center text-sm font-medium text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors group">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2 transition-transform group-hover:-translate-x-1"></i>
                    Voltar
                </a>
    <!-- Grid para as palavras -->
    <div id="inputsAreaNormal" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Os inputs das palavras ser√£o gerados aqui pelo JavaScript -->
    </div>

    <!-- Bot√µes de A√ß√£o -->
    <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-slate-200">
        <button type="submit" class="flex items-center justify-center gap-2 bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)] text-white px-6 py-3 rounded-lg w-full font-semibold shadow-md transition-transform transform hover:scale-105">
        <i data-lucide="send" class="w-5 h-5"></i>
        <span>Verificar Respostas</span>
        </button>
        <button type="button" id="btnNovas" class="flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-6 py-3 rounded-lg w-full font-semibold transition-transform transform hover:scale-105">
        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        <span>Novas Palavras</span>
        </button>
    </div>
    </form>

        <div id="feedbackAreaNormal" class="hidden mt-10">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-700">Resultados</h2>
            <div id="feedbackCardsNormal" class="space-y-4"></div>
            <div class="text-center mt-8">
                 <button id="btnJogarNovamenteNormal" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-105">Jogar Novamente</button>
            </div>
        </div>
    </div>

    <!-- √ÅREA DO JOGO - MODO CONTRA O TEMPO (ESCONDIDO) -->
    <div id="time-attack-mode-area" class="hidden max-w-3xl mx-auto">
        <!-- Status do Jogo (Vidas, Pontos, Cron√¥metro) -->
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-md">
            <div class="flex items-center gap-2">
                <i data-lucide="heart" class="text-red-500"></i>
                <span id="lives-counter" class="text-xl font-bold text-gray-700">3</span>
            </div>
            <div class="text-2xl font-bold text-purple-600">
                Pontos: <span id="score-counter">0</span>
            </div>
            <div class="flex items-center gap-2">
                <i data-lucide="clock" class="text-blue-500"></i>
                <span id="timer-display" class="text-xl font-bold text-gray-700">15</span>
            </div>
        </div>
        <!-- Barra de Tempo -->
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6 overflow-hidden">
            <div id="timer-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300"></div>
        </div>

        <!-- √Årea da Pergunta -->
        <div id="question-area" class="text-center">
            <!-- O conte√∫do ser√° injetado aqui -->
        </div>

        <!-- Tela de Fim de Jogo -->
        <div id="game-over-area" class="hidden text-center p-8 bg-white rounded-lg shadow-xl fade-in-up">
            <h2 class="text-4xl font-bold text-red-600 mb-4">Fim de Jogo!</h2>
            <p class="text-xl text-gray-700 mb-2">Sua pontua√ß√£o final foi:</p>
            <p id="final-score" class="text-6xl font-bold text-purple-600 mb-8">0</p>
            <div class="flex justify-center gap-4">
                <button id="restart-time-attack" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105">Jogar Novamente</button>
                <button id="back-to-menu" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105">Voltar ao Menu</button>
            </div>
        </div>
    </div>
</main>
<!-- üîπ Mascote Flutuante -->
<div id="mascote-assistente">
    <div id="chat-bubble">Vamos come√ßar o desafio?</div>
    <img src="../static/img/ortofix.png" alt="Assistente OrtoFix" class="mascote-img">
</div>

<footer class="navbar-theme text-[#e3ebf2] border-t border-gray-200 mt-auto">
    <div class="container mx-auto py-2 px-4 text-center text-sm">
        <div class="flex items-center justify-center gap-2">
            <p>&copy; 2025 OrtoFix</p>
            <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="h-6" style="filter: brightness(0) invert(1);">
        </div>
    </div>
</footer>

    
<!-- üîπ SONS -->
<audio id="click-sound" src="/static/audio/click.wav" preload="auto"></audio>
<audio id="submit-sound" src="/static/audio/confirm.wav" preload="auto"></audio>
<audio id="correct-sound" src="/static/audio/correct.mp3"preload="auto"></audio>
<audio id="wrong-sound" src="/static/audio/wrong.wav" preload="auto"></audio>
<audio id="game-over-sound" src="/static/audio/gameover.wav" preload="auto"></audio>


<!-- üîπ SCRIPT UNIFICADO -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Inicializa todos os √≠cones da p√°gina
    lucide.createIcons();
    preFetchWordForTimeAttack(); // Pr√©-busca a primeira palavra para o modo contra o tempo

    // ADICIONE ESTA NOVA FUN√á√ÉO (pode ser em qualquer lugar do script)
async function preFetchWordForTimeAttack() {
    try {
        const res = await fetch(`${API_URL}/api/ortofix/gerar_palavras?limite=1`, { method: 'POST' });
        if (res.ok) {
            const data = await res.json();
            preFetchedWord = data.palavras[0]; // Armazena a palavra na vari√°vel global
        }
    } catch (error) {
        console.error("Falha ao pr√©-carregar palavra:", error);
        preFetchedWord = null; // Garante que a vari√°vel esteja limpa em caso de erro
    }
}

    // --- ELEMENTOS GERAIS ---
    const mainMenu = document.getElementById('main-menu');
    const normalModeArea = document.getElementById('normal-mode-area');
    const timeAttackModeArea = document.getElementById('time-attack-mode-area');

    const startNormalModeBtn = document.getElementById('start-normal-mode');
    const startTimeAttackModeBtn = document.getElementById('start-time-attack-mode');
    
    // --- L√ìGICA DOS MENUS DROPDOWN (PAINEL E NOTIFICA√á√ïES) ---
    const menuBtn = document.getElementById("menu-btn");
    const dropdownMenu = document.getElementById("dropdown-menu");
    const notificationsBtn = document.getElementById("notifications-btn");
    const notificationsDropdown = document.getElementById("notifications-dropdown");

    const setupDropdown = (btn, menu) => {
        btn.addEventListener("click", (event) => {
            event.stopPropagation();
            const isHidden = menu.classList.contains("hidden");
            document.querySelectorAll('.absolute.z-\\[60\\]').forEach(m => m.classList.add('hidden'));
            if (isHidden) menu.classList.remove("hidden");
        });
    };
    setupDropdown(menuBtn, dropdownMenu);
    setupDropdown(notificationsBtn, notificationsDropdown);

    document.addEventListener("click", () => {
        document.querySelectorAll('.absolute.z-\\[60\\]').forEach(m => m.classList.add('hidden'));
    });

    // --- L√ìGICA DE SOM ---
    const soundBtn = document.getElementById("sound-btn");
    let soundEnabled = true; 
    const sounds = {
        click: document.getElementById("click-sound"),
        submit: document.getElementById("submit-sound"),
        correct: document.getElementById("correct-sound"),
        wrong: document.getElementById("wrong-sound"),
        gameOver: document.getElementById("game-over-sound")
    };

    const playSound = (soundName) => {
        if (soundEnabled && sounds[soundName]) {
            sounds[soundName].currentTime = 0;
            sounds[soundName].play().catch(() => {});
        }
    };

    if (soundBtn) {
        soundBtn.addEventListener("click", (event) => {
            event.preventDefault(); 
            soundEnabled = !soundEnabled;
            const icon = soundBtn.querySelector("i");
            icon.setAttribute("data-lucide", soundEnabled ? "volume-2" : "volume-x");
            icon.classList.toggle("text-red-500", !soundEnabled);
            lucide.createIcons();
        });
    }
    
    document.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="reset"], [tabindex="0"]')
        .forEach(el => {
            el.addEventListener("click", () => playSound('click'));
        });

    // --- L√ìGICA DO JOGO ---
    const API_URL = "https://api-tcc-alpha.vercel.app";

    // --- MODO NORMAL ---
    const btnIniciarNormal = document.getElementById('btnIniciarNormal');
    const formNormal = document.getElementById('formNormal');
    const feedbackAreaNormal = document.getElementById('feedbackAreaNormal');
    const feedbackCardsNormal = document.getElementById('feedbackCardsNormal');
    const inputsAreaNormal = document.getElementById('inputsAreaNormal');
    const btnNovas = document.getElementById('btnNovas');
    const startAreaNormal = document.getElementById('startAreaNormal');
    const btnJogarNovamenteNormal = document.getElementById('btnJogarNovamenteNormal');
    let palavrasAtuaisNormal = [];

    async function gerarPalavrasNormal() {
        hideMascote();
        formNormal.classList.remove('hidden');
    feedbackAreaNormal.classList.add('hidden');
        changeBubbleText("Boa sorte! Escolha os acentos com aten√ß√£o.");
        try {
            inputsAreaNormal.innerHTML = '<p class="text-center md:col-span-2 text-gray-500">Gerando novas palavras...</p>';
            formNormal.classList.remove('hidden');
            feedbackAreaNormal.classList.add('hidden');
            
            const res = await fetch(`${API_URL}/api/ortofix/gerar_palavras`, { method: 'POST' });
            if (!res.ok) throw new Error('Falha ao buscar palavras da API.');
            const data = await res.json();
            palavrasAtuaisNormal = data.palavras;
            renderInputsNormal(palavrasAtuaisNormal);
        } catch (error) {
            inputsAreaNormal.innerHTML = `<p class="text-center md:col-span-2 text-red-500">Erro: ${error.message}</p>`;
        }
    }

    // SUBSTITUA A FUN√á√ÉO renderInputsNormal
function renderInputsNormal(palavras) {
    inputsAreaNormal.innerHTML = '';
    palavras.forEach((palavra, index) => {
        const div = document.createElement('div');
        // Card agora usa as cores do tema
        div.className = 'p-5 rounded-xl shadow-inner transition-all duration-300 hover:shadow-md';
        div.style.backgroundColor = 'var(--color-card-bg)';
        div.style.border = '1px solid var(--color-border)';

        div.innerHTML = `
            <label class="block text-sm font-medium mb-2" style="color: var(--color-text-light);">Palavra ${index + 1}</label>
            <p class="text-2xl font-bold mb-3" style="color: var(--color-text-dark);">${palavra}</p>
            <input type="hidden" name="palavra_${index}" value="${palavra}" />
            <select name="acento_${index}" required class="w-full rounded-lg shadow-sm focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition" style="background-color: var(--color-background); color: var(--color-text-dark); border-color: var(--color-border);">
                <option value="" disabled selected>Escolha um acento...</option>
                <option value="agudo">Agudo (¬¥)</option>
                <option value="circunflexo">Circunflexo (^)</option>
                <option value="til">Til (~)</option>
                <option value="sem acento">Sem acento</option>
            </select>
        `;
        inputsAreaNormal.appendChild(div);
    });
    formNormal.classList.add('fade-in-up');
}

    function renderFeedbackNormal(feedbackRaw) {
        const linhas = feedbackRaw.trim().split('\n').filter(l => l.trim() !== '');
        const cards = [];
        let card = {};
        linhas.forEach(linha => {
            if (linha.startsWith('- Palavra:')) { if (Object.keys(card).length > 0) cards.push(card); card = {}; card.palavra = linha.replace('- Palavra:', '').trim(); }
            else if (linha.startsWith('- Sua resposta:')) card.resposta = linha.replace('- Sua resposta:', '').trim();
            else if (linha.startsWith('- Resposta correta:')) card.correta = linha.replace('- Resposta correta:', '').trim();
            else if (linha.startsWith('- Resultado:')) card.resultado = linha.replace('- Resultado:', '').trim();
            else if (linha.startsWith('- Explica√ß√£o:')) card.explicacao = linha.replace('- Explica√ß√£o:', '').trim();
        });
        if (Object.keys(card).length > 0) cards.push(card);

        feedbackCardsNormal.innerHTML = ''; 
        const acertos = cards.filter(c => c.resultado && c.resultado.includes('Correto')).length;
        const total = cards.length;
        
        if (total > 0) {
            const percentual = (acertos / total) * 100;
            if (percentual >= 75) {
                changeBubbleText("Uau, voc√™ foi incr√≠vel! Parab√©ns pelo √≥timo resultado!");
                changeMascoteImage("/static/img/success.webp");
            } else if (percentual >= 50) {
                changeBubbleText("Mandou bem! Continue praticando para ficar craque.");
                 changeMascoteImage("/static/img/ortofix.png");
            } else {
                changeBubbleText("N√£o desanime! Revisar as explica√ß√µes √© o segredo para aprender.");
                 changeMascoteImage("/static/img/ortofix.png");
            }
        }
        if (acertos === total && total > 0) launchConfetti();

        cards.forEach(c => {
            const isCorrect = c.resultado && c.resultado.includes('Correto');
            const cardClass = isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50';
            const icon = isCorrect ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-green-600"></i>' : '<i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>';
            const cardHTML = `
                <div class="border-l-4 ${cardClass} rounded-r-lg p-5 shadow-sm fade-in-up bg-white">
                    <div class="flex items-start gap-4">
                        <div>${icon}</div>
                        <div class="flex-grow">
                            <p class="text-xl font-bold text-[var(--color-text-dark)]">${c.palavra}</p>
                            <p class="text-sm text-gray-600 mt-2">Voc√™ respondeu <span class="font-semibold">${c.resposta}</span>, mas o correto era <span class="font-semibold">${c.correta}</span>.</p>
                            <p class="font-semibold mt-1 ${isCorrect ? 'text-green-700' : 'text-red-700'}">${c.resultado}</p>
                            <p class="text-sm text-gray-500 mt-3 pt-3 border-t border-gray-200"><strong>Explica√ß√£o:</strong> ${c.explicacao}</p>
                        </div>
                    </div>
                </div>`;
            feedbackCardsNormal.innerHTML += cardHTML;
        });

        feedbackAreaNormal.classList.remove('hidden');
        feedbackAreaNormal.classList.add('fade-in-up');
        lucide.createIcons();
        showMascote();
    }

    formNormal.addEventListener('submit', async (e) => {
        e.preventDefault();
        playSound('submit');
        const respostas = [];
        palavrasAtuaisNormal.forEach((_, index) => {
            const palavra = formNormal.querySelector(`input[name="palavra_${index}"]`).value;
            const resposta = formNormal.querySelector(`select[name="acento_${index}"]`).value;
            respostas.push({ palavra, resposta_usuario: resposta });
        });

        try {
            const res = await fetch(`${API_URL}/api/ortofix/verificar`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ respostas })
            });
            if (!res.ok) throw new Error('Falha ao verificar respostas.');
            const data = await res.json();
            renderFeedbackNormal(data.feedback);
            formNormal.classList.add('hidden'); 
        } catch (error) {
            feedbackCardsNormal.innerHTML = `<p class="text-center text-red-500">Erro: ${error.message}</p>`;
            feedbackAreaNormal.classList.remove('hidden');
        }
    });

    btnIniciarNormal.addEventListener('click', () => {
        gerarPalavrasNormal();
        startAreaNormal.classList.add('hidden');
    });

    btnNovas.addEventListener('click', () => {
        gerarPalavrasNormal();
    });
    btnJogarNovamenteNormal.addEventListener('click', () => {
        gerarPalavrasNormal();
    });


    // --- MODO CONTRA O TEMPO ---
    const livesCounter = document.getElementById('lives-counter');
    const scoreCounter = document.getElementById('score-counter');
    const timerDisplay = document.getElementById('timer-display');
    const timerBar = document.getElementById('timer-bar');
    const questionArea = document.getElementById('question-area');
    const gameOverArea = document.getElementById('game-over-area');
    const finalScore = document.getElementById('final-score');
    const restartTimeAttackBtn = document.getElementById('restart-time-attack');
    const backToMenuBtn = document.getElementById('back-to-menu');
    
let lives, score, timer, timerInterval, currentWord, currentTimeLimit;
let preFetchWord = null;
    const INITIAL_TIME = 10;

    function startGameTimeAttack() {
    lives = 3;
    score = 0;
    currentTimeLimit = INITIAL_TIME;
    livesCounter.textContent = lives;
    scoreCounter.textContent = score;
    gameOverArea.classList.add('hidden');
    questionArea.classList.remove('hidden');
    hideMascote();

    // Inicia o jogo com a palavra pr√©-carregada
    const firstWord = preFetchedWord;
    preFetchedWord = null; // Esvazia a vari√°vel para que ela n√£o seja usada duas vezes
    nextWord(firstWord); // Passa a palavra para a fun√ß√£o principal

    // Imediatamente come√ßa a carregar a PR√ìXIMA palavra em segundo plano
    preFetchWordForTimeAttack();
}

    async function nextWord(wordToUse = null) {
    // 1. Garante que o jogo n√£o continue se as vidas acabaram
    if (lives <= 0) return;

    // 2. Limpa qualquer cron√¥metro anterior para evitar contagens duplas
    clearInterval(timerInterval);

    // 3. Ajusta o tempo limite com base na pontua√ß√£o (dificuldade progressiva)
    if (score >= 200) {
        currentTimeLimit = 5;
    } else if (score >= 100) {
        currentTimeLimit = 7;
    } else {
        currentTimeLimit = INITIAL_TIME;
    }
    
    // 4. Define o contador de tempo e atualiza a interface
    timer = currentTimeLimit;
    updateTimerDisplay();

    // 5. Reinicia a anima√ß√£o da barra de tempo visual
    timerBar.style.animation = 'none';
    timerBar.offsetHeight; // For√ßa o navegador a processar a remo√ß√£o da anima√ß√£o
    timerBar.style.animation = `decrease ${currentTimeLimit}s linear forwards`;

    // 6. Inicia o cron√¥metro regressivo de 1 segundo
    timerInterval = setInterval(() => {
        timer--;
        updateTimerDisplay();
        if (timer <= 0) {
            handleAnswer(false); // Considera tempo esgotado como erro
        }
    }, 1000);

    // 7. Bloco principal para obter e exibir a palavra
    try {
        if (wordToUse) {
            // Se uma palavra foi pr√©-carregada e passada para a fun√ß√£o, usa-a imediatamente
            currentWord = wordToUse;
        } else {
            // Caso contr√°rio (se o pr√©-carregamento falhou ou na primeira rodada sem a otimiza√ß√£o),
            // busca uma nova palavra da API como um fallback seguro.
            console.warn("Nenhuma palavra pr√©-carregada, buscando da API...");
            const res = await fetch(`${API_URL}/api/ortofix/gerar_palavras?limite=1`, { method: 'POST' });
            if (!res.ok) throw new Error('Falha ao buscar palavra da API.');
            const data = await res.json();
            currentWord = data.palavras[0];
        }
        // 8. Renderiza o card da pergunta com a palavra obtida
        renderQuestion(currentWord);

    } catch (error) {
        // Em caso de erro na API, exibe uma mensagem para o jogador
        console.error("Erro em nextWord:", error);
        questionArea.innerHTML = `<p class="text-center text-red-500">Erro ao carregar palavra: ${error.message}</p>`;
    }
}

    function renderQuestion(palavra) {
    questionArea.innerHTML = `
        <div class="p-8 rounded-xl shadow-lg fade-in-up" style="background-color: var(--color-card-bg); border: 1px solid var(--color-border);">
            <p class="text-lg mb-2" style="color: var(--color-text-light);">Qual o acento correto para:</p>
            <h2 class="text-5xl font-bold mb-8" style="color: var(--color-text-dark);">${palavra}</h2>
            <div class="grid grid-cols-2 gap-4">
                <button data-answer="agudo" class="answer-btn font-semibold py-4 rounded-lg transition" style="background-color: var(--color-border); color: var(--color-text-dark);">Agudo (¬¥)</button>
                <button data-answer="circunflexo" class="answer-btn font-semibold py-4 rounded-lg transition" style="background-color: var(--color-border); color: var(--color-text-dark);">Circunflexo (^)</button>
                <button data-answer="til" class="answer-btn font-semibold py-4 rounded-lg transition" style="background-color: var(--color-border); color: var(--color-text-dark);">Til (~)</button>
                <button data-answer="sem acento" class="answer-btn font-semibold py-4 rounded-lg transition" style="background-color: var(--color-border); color: var(--color-text-dark);">Sem Acento</button>
            </div>
        </div>`;
        
        document.querySelectorAll('.answer-btn').forEach(btn => {
             btn.addEventListener('mouseenter', () => btn.style.backgroundColor = 'var(--color-primary)');
        btn.addEventListener('mouseleave', () => btn.style.backgroundColor = 'var(--color-border)');
            btn.addEventListener('click', async (e) => {
                const userAnswer = e.target.getAttribute('data-answer');
                // Desabilita bot√µes para evitar cliques m√∫ltiplos
                document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
                
                const res = await fetch(`${API_URL}/api/ortofix/verificar`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ respostas: [{ palavra: currentWord, resposta_usuario: userAnswer }] })
                });
                const data = await res.json();
                const isCorrect = data.feedback.includes("Resultado: Correto");

                // Feedback visual no bot√£o clicado
                e.target.classList.add(isCorrect ? 'bg-green-500' : 'bg-red-500', 'text-white');

                handleAnswer(isCorrect);
            });
        });
    }

    function handleAnswer(isCorrect) {
        clearInterval(timerInterval);
        timerBar.style.animationPlayState = 'paused';

         const wordForNextRound = preFetchedWord; // Guarda a palavra que j√° foi pr√©-carregada
    preFetchedWord = null; // Limpa a vari√°vel

    // Inicia o pr√©-carregamento para a rodada SEGUINTE em segundo plano
    preFetchWordForTimeAttack(); 

        if (isCorrect) {
            playSound('correct');
            score += 10;
            scoreCounter.textContent = score;
            setTimeout(() => nextWord(wordForNextRound), 1000); 
        } else {
            playSound('wrong');
            triggerErrorAnimation();
            lives--;
            livesCounter.textContent = lives;
            if (lives <= 0) {
                gameOver();
            } else {
                 setTimeout(() => nextWord(wordForNextRound), 1500); // Espera 1.5s (mais tempo para ver o erro)
            }
        }
    }

    function gameOver() {
        playSound('gameOver');
        clearInterval(timerInterval);
        finalScore.textContent = score;
        questionArea.classList.add('hidden');
        gameOverArea.classList.remove('hidden');
        changeBubbleText(`Fim de jogo! Voc√™ fez ${score} pontos. Que tal tentar de novo?`);
        changeMascoteImage("/static/img/ortofix.png");
        showMascote();
    }

    function updateTimerDisplay() {
        timerDisplay.textContent = timer;
        const percentage = (timer / INITIAL_TIME) * 100;
        
        // Atualiza√ß√£o da cor da barra de tempo
        if(percentage < 25) {
             timerBar.classList.remove('bg-yellow-500');
             timerBar.classList.add('bg-red-500');
        } else if (percentage < 50) {
            timerBar.classList.remove('bg-blue-500');
            timerBar.classList.add('bg-yellow-500');
        } else {
            timerBar.classList.remove('bg-yellow-500', 'bg-red-500');
            timerBar.classList.add('bg-blue-500');
        }
    }

    // --- CONTROLES DE NAVEGA√á√ÉO ENTRE MODOS ---
    startNormalModeBtn.addEventListener('click', () => {
        mainMenu.classList.add('hidden');
        normalModeArea.classList.remove('hidden');
    });

    startTimeAttackModeBtn.addEventListener('click', () => {
        mainMenu.classList.add('hidden');
        timeAttackModeArea.classList.remove('hidden');
        startGameTimeAttack();
    });

    restartTimeAttackBtn.addEventListener('click', startGameTimeAttack);

    backToMenuBtn.addEventListener('click', () => {
        timeAttackModeArea.classList.add('hidden');
        mainMenu.classList.remove('hidden');
        showMascote();
        changeBubbleText("Clique em 'Come√ßar a Jogar' para testar seus conhecimentos!");
    });

    // --- L√ìGICA DO MASCOTE ---
    const mascoteAssistente = document.getElementById('mascote-assistente');
    const chatBubble = document.getElementById('chat-bubble');

    const showMascote = () => mascoteAssistente.classList.add('visible');
    const hideMascote = () => mascoteAssistente.classList.remove('visible');

    const changeBubbleText = (text) => {
        chatBubble.classList.remove('show');
        setTimeout(() => {
            chatBubble.textContent = text;
            chatBubble.classList.add('show');
        }, 300);
    };
    
    const changeMascoteImage = (imageSrc) => {
        const mascoteImgElement = document.querySelector('#mascote-assistente .mascote-img');
        if (mascoteImgElement) mascoteImgElement.src = imageSrc;
    };

    setTimeout(() => {
        showMascote();
        changeBubbleText("Escolha um modo de jogo para come√ßar o desafio!");
    }, 1500);

    function launchConfetti() {
        confetti({
            particleCount: 150, spread: 500, origin: { y: 0.6 }, angle: 90, startVelocity: 40, colors: ['#4A90E2', '#50E3C2', '#FFFFFF', '#357ABD'] 
        });
    }
});
// --- L√ìGICA DO CANVAS E ANIMA√á√ÉO (VERS√ÉO PROFISSIONAL) ---
const feedbackCanvas = document.getElementById('feedback-canvas');
const ctx = feedbackCanvas.getContext('2d');
let effects = [];
const gravity = 0.1;

function resizeCanvas() {
    feedbackCanvas.width = window.innerWidth;
    feedbackCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Loop principal que desenha e atualiza todos os efeitos
function animateEffects() {
    ctx.clearRect(0, 0, feedbackCanvas.width, feedbackCanvas.height);
    
    // Usamos um loop `for` reverso para poder remover itens do array com seguran√ßa
    for (let i = effects.length - 1; i >= 0; i--) {
        const effect = effects[i];
        
        effect.update();
        effect.draw();

        // Remove o efeito se sua vida √∫til acabou
        if (effect.life <= 0) {
            effects.splice(i, 1);
        }
    }
    requestAnimationFrame(animateEffects);
}

// --- CLASSES PARA CADA TIPO DE EFEITO ---

// 1. Part√≠cula da explos√£o
class Particle {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.size = Math.random() * 5 + 2;
        this.life = 1; // Representa 100% da vida
        // Velocidade inicial aleat√≥ria para a explos√£o
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() * -5) - 3;
    }
    update() {
        this.vy += gravity; // Aplica gravidade
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.02; // Perde vida (desaparece)
    }
    draw() {
        ctx.fillStyle = `rgba(239, 68, 68, ${this.life})`; // red-500
        ctx.fillRect(this.x, this.y, this.size, this.size);
    }
}

// 2. C√≠rculo da explos√£o radial
class RadialBurst {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = 0;
        this.maxRadius = 150;
        this.life = 1;
    }
    update() {
        this.radius += 15; // Expande rapidamente
        this.life -= 0.05;
    }
    draw() {
        ctx.beginPath();
        const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius);
        gradient.addColorStop(0, `rgba(239, 68, 68, ${this.life * 0.5})`);
        gradient.addColorStop(1, `rgba(239, 68, 68, 0)`);
        ctx.fillStyle = gradient;
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
    }
}

// 3. √çcone "X" central
class ErrorIcon {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.size = 0;
        this.maxSize = 100;
        this.life = 1;
        this.rotation = -Math.PI / 4;
    }
    update() {
        // Anima√ß√£o de "overshoot": cresce um pouco a mais e depois volta
        if (this.size < this.maxSize) {
            this.size += 15;
        } else if (this.size > this.maxSize - 10) {
            this.size -= 1;
        }
        this.rotation += 0.1;
        this.life -= 0.025;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.font = `bold ${this.size}px Poppins`;
        ctx.fillStyle = `rgba(255, 255, 255, ${this.life})`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('‚úï', 0, 0); // Caractere de "X" (multiplication X)
        ctx.restore();
    }
}

// Fun√ß√£o principal que orquestra todos os efeitos de erro
function triggerErrorAnimation() {
    const centerX = feedbackCanvas.width / 2;
    const centerY = feedbackCanvas.height / 2;

    // 1. Adiciona a explos√£o radial
    effects.push(new RadialBurst(centerX, centerY));

    // 2. Adiciona o √≠cone "X"
    effects.push(new ErrorIcon(centerX, centerY));

    // 3. Adiciona 20 part√≠culas para a explos√£o
    for (let i = 0; i < 20; i++) {
        effects.push(new Particle(centerX, centerY));
    }

    // 4. Adiciona o efeito de tremor ao card da pergunta
    const questionCard = document.querySelector('#question-area > div');
    if (questionCard) {
        questionCard.classList.add('shake-effect');
        setTimeout(() => {
            questionCard.classList.remove('shake-effect');
        }, 300); // Dura√ß√£o da anima√ß√£o em ms, deve ser igual √† do CSS
    }
}

animateEffects(); // Inicia o loop de anima√ß√£o global
</script>

<script src="global-init.js"></script>
</body>
</html>