<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrtoFix - TypeRun</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            color: #3c6a99; /* Cor padrão do texto */
        }
        .navbar-logo {
            height: 40px;
            width: auto;
        }
        .word-card, .all-correct-btn { /* Aplicando estilos base para ambos */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            min-height: 80px; /* Altura mínima para consistência */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center; /* Para o botão "Todas corretas" */
        }
        .word-card:hover:not(:disabled), .all-correct-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .selected-correct-answer { /* Usuário CLICOU na palavra que ESTAVA ERRADA OU no botão "Todas corretas" quando era o caso */
            background-color: #34d399; /* Tailwind green-400 */
            color: white;
            border-color: #10b981; /* Tailwind green-500 */
        }
        .selected-wrong-answer { /* Usuário CLICOU numa palavra que ESTAVA CORRETA ou no botão errado */
            background-color: #f87171; /* Tailwind red-400 */
            color: white;
            border-color: #ef4444; /* Tailwind red-500 */
        }
        .word-card:disabled, .all-correct-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3c6a99; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#e3ebf2] min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-[#3c6a99] text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <button id="menu-btn" class="p-2 focus:outline-none focus:bg-[#5689b9] rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-[#e3ebf2]">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div id="dropdown-menu" class="absolute left-4 top-16 bg-white rounded-lg shadow-xl py-2 w-48 hidden z-[60]">
                <a href="inicio.html" class="block px-4 py-2 text-[#3c6a99] hover:bg-[#e3ebf2]">Início</a>
                 <a href="../index.html" class="block px-4 py-2 text-[#3c6a99] hover:bg-[#e3ebf2]">Correção de Texto</a>
                <a href="#" class="block px-4 py-2 text-[#3c6a99] hover:bg-[#e3ebf2]">Som</a>
                <a href="#" class="block px-4 py-2 text-[#3c6a99] hover:bg-[#e3ebf2]">Notificações</a>
            </div>
            <a href="../index.html">
                <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="navbar-logo">
            </a>
            <a href="perfil.html" class="p-2 focus:outline-none focus:bg-[#5689b9] rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-[#e3ebf2]">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </a>
        </div>
    </nav>

    <main class="container mx-auto px-4 sm:px-6 py-6 flex-grow">
        <div class="mb-6">
            <a href="atividades.html" class="inline-flex items-center text-[#3c6a99] hover:text-[#5689b9] transition-colors text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Voltar
            </a>
        </div>

        <div class="text-center bg-white shadow-xl rounded-xl p-6 md:p-8">
            <h1 id="game-instruction" class="text-xl sm:text-2xl font-semibold text-[#3c6a99] mb-8">
                Escolha a palavra com erro ortográfico.
            </h1>

            <div id="loading-words" class="loading-spinner my-8 hidden"></div>
            <p id="api-error" class="text-sm text-red-600 bg-red-100 border border-red-400 p-3 rounded-md hidden mb-4"></p>

            <div id="words-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 max-w-2xl mx-auto mb-6">
                <!-- Os botões de palavra serão inseridos aqui -->
            </div>
            <div id="all-correct-container" class="max-w-2xl mx-auto mb-10">
                <!-- Botão "Todas estão corretas" será inserido aqui -->
            </div>


            <div id="feedback-area" class="mb-8 min-h-[60px] flex items-center justify-center text-lg font-medium">
                <!-- Feedback será inserido aqui -->
            </div>

            <button id="next-question-btn" class="bg-[#8bb3d5] hover:bg-[#5689b9] text-white font-bold py-3 px-8 rounded-lg text-lg shadow-md transition-colors">
                Próximo
            </button>
        </div>
    </main>

    <footer class="bg-[#3c6a99] text-[#e3ebf2] text-center p-4 mt-auto">
        <p>© 2025 OrtoFix.</p>
    </footer>

    <script>
        const menuBtn = document.getElementById('menu-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');
        if (menuBtn && dropdownMenu) {
            menuBtn.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (menuBtn && dropdownMenu && !menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        const wordsContainer = document.getElementById('words-container');
        const allCorrectContainer = document.getElementById('all-correct-container');
        const feedbackArea = document.getElementById('feedback-area');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const loadingWordsSpinner = document.getElementById('loading-words');
        const apiErrorP = document.getElementById('api-error');
        const gameInstructionH1 = document.getElementById('game-instruction');

        const API_BASE_URL = "https://api-tcc-alpha.vercel.app";

        let currentWordsData = [];
        let todasAsPalavrasEstaoCorretasOpcaoGlobal = false; // Para saber se a opção "todas corretas" é a certa
        let roundOver = false; // Para controlar se a rodada terminou

        function displayLoading(isLoading) {
            loadingWordsSpinner.style.display = isLoading ? 'block' : 'none';
            wordsContainer.style.display = isLoading ? 'none' : 'grid'; // 'grid' para manter o layout
            allCorrectContainer.style.display = isLoading ? 'none' : 'block';
            apiErrorP.classList.add('hidden');
            nextQuestionBtn.disabled = isLoading;
            feedbackArea.innerHTML = '';
            gameInstructionH1.textContent = isLoading ? "Carregando palavras..." : "Escolha a palavra com erro ortográfico.";
             if (isLoading) {
                wordsContainer.innerHTML = ''; // Limpa palavras anteriores
                allCorrectContainer.innerHTML = ''; // Limpa botão "todas corretas"
            }
        }

        function displayApiError(message) {
            apiErrorP.textContent = message;
            apiErrorP.classList.remove('hidden');
            wordsContainer.innerHTML = '';
            allCorrectContainer.innerHTML = '';
            feedbackArea.innerHTML = '';
            loadingWordsSpinner.style.display = 'none';
            nextQuestionBtn.disabled = false; // Permite tentar de novo se a API falhar no load
        }

        async function loadNewTypeRunQuestion() {
            displayLoading(true);
            roundOver = false; // Nova rodada, resetar

            try {
                const response = await fetch(`${API_BASE_URL}/api/typerun/gerar_palavras`, { method: 'POST' });
                if (!response.ok) {
                    const errText = await response.text(); // Pegar texto do erro
                    let errMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errData = JSON.parse(errText);
                        errMessage = errData.error || errMessage;
                    } catch (e) { /* Ignora se não for JSON */ }
                    throw new Error(errMessage);
                }
                const data = await response.json();
                currentWordsData = data.palavras;
                todasAsPalavrasEstaoCorretasOpcaoGlobal = data.todas_as_palavras_estao_corretas_opcao === true;
                populateWordCards();
                feedbackArea.innerHTML = '';
                enableAllOptions(); // Habilita botões para a nova rodada
            } catch (err) {
                console.error('Erro ao carregar palavras TypeRun:', err);
                displayApiError(`Falha ao carregar palavras: ${err.message}. Verifique o console e tente novamente.`);
            } finally {
                displayLoading(false);
                // O botão "Próximo" só deve ser habilitado após uma resposta na rodada.
                // E desabilitado ao carregar uma nova pergunta.
                nextQuestionBtn.disabled = true;
            }
        }
        
        function enableAllOptions() {
            document.querySelectorAll('#words-container .word-card, #all-correct-container .all-correct-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected-correct-answer', 'selected-wrong-answer');
            });
        }

        function disableAllOptions() {
            document.querySelectorAll('#words-container .word-card, #all-correct-container .all-correct-btn').forEach(btn => {
                btn.disabled = true;
            });
        }


        function populateWordCards() {
            wordsContainer.innerHTML = '';
            allCorrectContainer.innerHTML = ''; // Limpa o botão anterior

            currentWordsData.forEach(wordObj => {
                const button = document.createElement('button');
                button.classList.add('word-card', 'bg-white', 'text-[#3c6a99]', 'border-2', 'border-[#9aaec1]', 'hover:border-[#5689b9]', 'rounded-lg', 'p-4', 'text-xl', 'font-medium', 'shadow-sm');
                button.textContent = wordObj.palavra;
                button.onclick = () => handleWordSelection(button, wordObj);
                wordsContainer.appendChild(button);
            });

            // Adicionar o botão "Todas as palavras estão corretas"
            const allCorrectButton = document.createElement('button');
            allCorrectButton.textContent = "Todas as palavras estão corretas";
            allCorrectButton.classList.add('all-correct-btn', 'w-full', 'sm:col-span-2', 'bg-gray-200', 'text-[#3c6a99]', 'border-2', 'border-[#9aaec1]', 'hover:border-[#5689b9]', 'rounded-lg', 'p-4', 'text-lg', 'font-medium', 'shadow-sm', 'mt-2');
            // O sm:col-span-2 faz com que ele ocupe as duas colunas em telas sm ou maiores se o wordsContainer for grid de 2 colunas.
            // Se wordsContainer for flex, ajuste o layout do allCorrectContainer conforme necessário.
            allCorrectButton.onclick = () => handleAllCorrectSelection(allCorrectButton);
            allCorrectContainer.appendChild(allCorrectButton);
        }

        function handleWordSelection(selectedButton, wordObject) {
            if (roundOver) return;
            roundOver = true;
            disableAllOptions(); // Desabilita todos os botões, incluindo "todas corretas"
            selectedButton.disabled = false; // Mantém o clicado "ativo" para estilo

            if (wordObject.esta_errada) { // Usuário clicou na palavra que o Gemini marcou como errada
                selectedButton.classList.add('selected-correct-answer');
                feedbackArea.innerHTML = `<span class="text-green-600">Correto!</span> ${wordObject.explicacao || `A palavra "${wordObject.palavra}" estava escrita incorretamente.`}`;
            } else { // Usuário clicou numa palavra correta
                selectedButton.classList.add('selected-wrong-answer');
                const correctAnswerObj = currentWordsData.find(p => p.esta_errada);
                let explanation = `Ops! "${wordObject.palavra}" está correta.`;
                if (correctAnswerObj) { // Se houver uma palavra errada definida pelo Gemini
                    explanation += ` A palavra com erro era "${correctAnswerObj.palavra}". ${correctAnswerObj.explicacao || ''}`;
                } else { // Se o Gemini disse que todas estavam corretas (e o usuário não clicou em "todas corretas")
                    explanation += ` Todas as palavras estavam corretas desta vez.`;
                }
                feedbackArea.innerHTML = `<span class="text-red-500">Errado!</span> ${explanation}`;
            }
            nextQuestionBtn.disabled = false; // Habilita o botão Próximo
        }

        function handleAllCorrectSelection(selectedButton) {
            if (roundOver) return;
            roundOver = true;
            disableAllOptions();
            selectedButton.disabled = false;

            if (todasAsPalavrasEstaoCorretasOpcaoGlobal) { // O backend indicou que todas estão corretas
                selectedButton.classList.add('selected-correct-answer');
                feedbackArea.innerHTML = `<span class="text-green-600">Correto!</span> Todas as palavras estavam escritas corretamente desta vez.`;
            } else { // O backend indicou que HAVIA uma palavra errada
                selectedButton.classList.add('selected-wrong-answer');
                const correctAnswerObj = currentWordsData.find(p => p.esta_errada);
                let explanation = `Ops! Havia uma palavra escrita incorretamente.`;
                if (correctAnswerObj) {
                    explanation += ` Era "${correctAnswerObj.palavra}". ${correctAnswerObj.explicacao || ''}`;
                }
                feedbackArea.innerHTML = `<span class="text-red-500">Errado!</span> ${explanation}`;
            }
            nextQuestionBtn.disabled = false;
        }
        
        nextQuestionBtn.addEventListener('click', () => {
            if (!nextQuestionBtn.disabled) { // Adiciona verificação para segurança
                 loadNewTypeRunQuestion();
            }
        });

        document.addEventListener('DOMContentLoaded', loadNewTypeRunQuestion);
    </script>
</body>
</html>