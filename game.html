<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>OrtoFix - Tipos de Acento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; color: #3c6a99; }
    </style>
</head>
<body class="bg-[#e3ebf2] min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-[#3c6a99] text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="inicio.html">
                <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="w-10">
            </a>
            <div class="flex gap-4">
                <a href="inicio.html" class="hover:underline">Início</a>
                <a href="atividades.html" class="hover:underline">Atividades</a>
                <a href="../index.html" class="hover:text-red-400">Sair</a>
            </div>
        </div>
    </nav>

    <!-- Conteúdo -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        <h1 class="text-3xl font-bold text-center mb-4">Ortofix Game</h1>
        <p class="text-lg text-center text-[#5689b9] mb-6">Escolha o tipo de acento correto para cada palavra.</p>

        <div id="formArea" class="bg-white rounded-xl shadow-lg p-6 max-w-3xl mx-auto hidden">
            <form id="form">
                <div id="inputsArea" class="grid grid-cols-1 gap-6"></div>

                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button type="submit"
                        class="bg-[#3c6a99] hover:bg-[#5689b9] text-white px-6 py-2 rounded-md w-full">
                        Enviar Respostas
                    </button>
                    <button type="button" id="btnNovas"
                        class="bg-white border border-[#3c6a99] hover:bg-[#e3ebf2] text-[#3c6a99] px-6 py-2 rounded-md w-full">
                        Gerar Novas Palavras
                    </button>
                </div>
            </form>
        </div>

        <div id="feedbackArea" class="bg-white rounded-xl shadow-lg p-6 mt-8 max-w-3xl mx-auto hidden">
            <h2 class="text-2xl font-bold text-[#3c6a99] mb-4">Feedback</h2>
            <div id="feedbackCards" class="space-y-4"></div>
        </div>

        <div class="flex justify-center mt-6">
            <button id="btnIniciar"
                class="bg-[#3c6a99] hover:bg-[#5689b9] text-white px-6 py-3 rounded-md">
                Iniciar Jogo
            </button>
        </div>
    </main>

    <footer class="bg-[#3c6a99] text-[#e3ebf2] text-center p-4 mt-auto">
        <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="h-10 mx-auto " style="filter: brightness(0) invert(1);">
        <p>© 2025 OrtoFix.</p>
    </footer>

    <!-- Substitua a tag <script> inteira no final de game.html por este bloco -->
<script>
    // --- CONSTANTES E VARIÁVEIS GLOBAIS ---
    const API_URL_GEMINI = "https://api-tcc-alpha.vercel.app";
    const API_URL_BACKEND = "https://back-end-mvp-tcc.vercel.app";

    // Elementos do DOM
    const btnIniciar = document.getElementById('btnIniciar');
    const btnNovas = document.getElementById('btnNovas');
    const formArea = document.getElementById('formArea');
    const feedbackArea = document.getElementById('feedbackArea');
    const feedbackCards = document.getElementById('feedbackCards');
    const inputsArea = document.getElementById('inputsArea');
    const form = document.getElementById('form');

    // Variáveis de estado
    let palavrasAtuais = [];

    // --- FUNÇÕES HELPER (REUTILIZÁVEIS) ---
    function showRewardToast(message, coins) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg flex items-center gap-3 z-[100] transform translate-x-full animate-slide-in';
        toast.innerHTML = `
            <i data-lucide="party-popper" class="w-8 h-8"></i>
            <div>
                <p class="font-bold">${message}</p>
                <p class="text-sm">Você ganhou +${coins} moedas!</p>
            </div>
        `;
        document.body.appendChild(toast);
        lucide.createIcons();
        setTimeout(() => {
            toast.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

        // NOVA FUNÇÃO DE ANIMAÇÃO DE RECOMPENSA
    function showRewardToast(coins) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-5 right-5 bg-yellow-400 text-gray-800 p-4 rounded-lg shadow-2xl flex items-center gap-4 z-[100] border-4 border-yellow-300';
        toast.style.transform = 'translateX(120%)';
        toast.style.transition = 'transform 0.5s ease-in-out';
        
        toast.innerHTML = `
            <i data-lucide="party-popper" class="w-10 h-10 text-yellow-600"></i>
            <div>
                <p class="font-bold text-lg">Recompensa Recebida!</p>
                <p class="text-base">Você ganhou +${coins} moedas!</p>
            </div>
        `;
        document.body.appendChild(toast);
        lucide.createIcons();
        
        // Animação de entrada
        setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);

        // Animação de saída
        setTimeout(() => {
            toast.style.transform = 'translateX(120%)';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    async function registrarAtividadeConcluida(pontuacao, feedback) {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        try {
            const response = await fetch(`${API_BACKEND_URL}/api/atividades/completar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    idAtividade: 1, // ID para "Correção de Texto"
                    pontuacao: pontuacao,
                    feedbackGemini: feedback
                })
            });
            const result = await response.json();
            if (response.ok) {
                showRewardToast(result.moedasGanhas);
            } else {
                alert(`Erro ao salvar progresso: ${result.msg}`);
            }
        } catch (error) {
            console.error("Erro ao registrar atividade:", error);
        }
    }

     async function registrarAtividadeConcluida(pontuacao, feedback) {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        try {
            const response = await fetch(`${API_URL_BACKEND}/api/atividades/completar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    idAtividade: 2, // ID para "OrtoFix Game"
                    pontuacao: pontuacao,
                    feedbackGemini: feedback
                })
            });
            const result = await response.json();
            if (response.ok) {
                showRewardToast(result.moedasGanhas);
            }
        } catch (error) { console.error("Erro ao registrar atividade:", error); }
    }

    // --- LÓGICA DO JOGO ---
    async function gerarPalavras() {
        btnIniciar.textContent = "Carregando...";
        btnIniciar.disabled = true;
        const res = await fetch(`${API_URL_GEMINI}/api/ortofix/gerar_palavras`, { method: 'POST' });
        const data = await res.json();
        palavrasAtuais = data.palavras;
        renderInputs(palavrasAtuais);
        formArea.classList.remove('hidden');
        feedbackArea.classList.add('hidden');
        btnIniciar.classList.add('hidden');
        btnIniciar.textContent = "Iniciar Jogo";
        btnIniciar.disabled = false;
    }

    function renderInputs(palavras) {
        inputsArea.innerHTML = '';
        palavras.forEach((palavra, index) => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-[#3c6a99] font-semibold mb-1">
                    Palavra: <span class="font-bold">${palavra}</span>
                </label>
                <input type="hidden" name="palavra_${index}" value="${palavra}" />
                <select name="acento_${index}" class="w-full border border-[#3c6a99] rounded-md px-4 py-2">
                    <option value="" disabled selected>Escolha o acento...</option>
                    <option value="agudo">Agudo (´)</option>
                    <option value="circunflexo">Circunflexo (^)</option>
                    <option value="til">Til (~)</option>
                    <option value="sem acento">Sem acento</option>
                </select>
            `;
            inputsArea.appendChild(div);
        });
    }

    function renderFeedback(feedbackRaw) {
        const linhas = feedbackRaw.trim().split('\n').filter(l => l.trim() !== '');
        const cards = [];
        let card = {};
        linhas.forEach(linha => {
            if (linha.startsWith('- Palavra:')) {
                if (Object.keys(card).length > 0) cards.push(card);
                card = { palavra: linha.replace('- Palavra:', '').trim() };
            } else if (linha.startsWith('- Sua resposta:')) card.resposta = linha.replace('- Sua resposta:', '').trim();
            else if (linha.startsWith('- Resposta correta:')) card.correta = linha.replace('- Resposta correta:', '').trim();
            else if (linha.startsWith('- Resultado:')) card.resultado = linha.replace('- Resultado:', '').trim();
            else if (linha.startsWith('- Explicação:')) card.explicacao = linha.replace('- Explicação:', '').trim();
        });
        if (Object.keys(card).length > 0) cards.push(card);

        feedbackCards.innerHTML = '';
        cards.forEach(c => {
            const cor = c.resultado && c.resultado.includes('Correto') ? 'bg-green-100 border-green-400 text-green-800' : 'bg-red-100 border-red-400 text-red-800';
            const html = `<div class="border ${cor} rounded-xl p-4">...</div>`; // Seu innerHTML do card aqui
            feedbackCards.innerHTML += html.replace('...', `<p><strong>Palavra:</strong> ${c.palavra}</p><p><strong>Sua resposta:</strong> ${c.resposta}</p><p><strong>Resposta correta:</strong> ${c.correta}</p><p><strong>Resultado:</strong> <span class="font-semibold">${c.resultado}</span></p><p class="mt-2"><strong>Explicação:</strong> ${c.explicacao}</p>`);
        });
    }

    // --- LÓGICA DE EVENTOS ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const respostas = [];
        palavrasAtuais.forEach((palavra, index) => {
            const resposta = form.querySelector(`select[name="acento_${index}"]`).value;
            respostas.push({ palavra, resposta_usuario: resposta });
        });

        const res = await fetch(`${API_URL_GEMINI}/api/ortofix/verificar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ respostas })
        });
        const data = await res.json();
        renderFeedback(data.feedback);
        feedbackArea.classList.remove('hidden');

        // --- LÓGICA DE PONTUAÇÃO E RECOMPENSA ---
        let acertos = (data.feedback.match(/Resultado: Correto!/g) || []).length;
        const pontuacao = (acertos / palavrasAtuais.length) * 100;
        await registrarAtividadeConcluida(Math.round(pontuacao), data.feedback);
    });

    btnIniciar.addEventListener('click', gerarPalavras);
    btnNovas.addEventListener('click', gerarPalavras);
</script>
</body>
</html>