<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrtoFix - Login do Aluno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="./static/img/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc; 
        }
        .form-input:focus-within {
            border-color: #3c6a99;
            box-shadow: 0 0 0 2px rgba(60, 106, 153, 0.2);
        }
        /* Animações para o modal <dialog> */
        dialog[open] {
            animation: fadeIn 0.3s ease-out;
        }
        dialog[open] .modal-content {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="text-slate-700">
    
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <img src="./static/img/ortofix.png" alt="OrtoFix Logo" class="h-12">
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="../index.html#features" class="hover:text-[#3c6a99] transition-colors">Funcionalidades</a>
                <a href="cadastro.html" class="bg-[#5689b9] hover:bg-[#3c6a99] text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                    Cadastro
                </a>
            </div>
        </nav>
    </header>

    <!-- O Modal para Retomar Sessão usando a tag <dialog> para melhor acessibilidade -->
    <dialog id="resume-session-modal" class="p-0 rounded-2xl shadow-xl max-w-sm w-full mx-auto backdrop:bg-black/50">
        <div class="modal-content bg-white p-8 sm:p-10 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-[#3c6a99] mb-4 leading-tight">Sessão Ativa!</h3>
            <p class="text-lg text-gray-600 mb-8 leading-relaxed">Deseja continuar de onde parou?</p>
            <div class="flex flex-col space-y-4">
                <button id="resume-session-btn-modal" class="group w-full bg-[#3c6a99] hover:bg-[#5689b9] text-white font-bold py-3 px-5 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    Sim, continuar
                </button>
                <button id="clear-session-btn-modal" class="group w-full border-2 border-[#3c6a99] text-[#3c6a99] font-bold py-3 px-5 rounded-xl hover:bg-gray-50 transition-all duration-300 ease-in-out">
                    Não, fazer um novo login
                </button>
            </div>
        </div>
    </dialog>

    <main class="flex-grow">
        <section class="py-20 md:py-24 px-6">
            <div class="container mx-auto grid grid-cols-1 md:grid-cols-2 gap-12 items-center max-w-6xl">
                
                <div class="hidden md:flex flex-col items-center text-center" data-aos="fade-right">
                    <h2 class="text-3xl font-bold text-[#3c6a99] mt-8">Sua jornada para uma ortografia perfeita continua.</h2>
                    <p class="text-slate-500 mt-4">Aprender é uma aventura. Continue de onde parou e conquiste novas habilidades!</p>
                </div>

                <div class="bg-white shadow-xl rounded-xl p-8 md:p-10 w-full" data-aos="fade-left">
                    <div class="text-center mb-6">
                        <a href="../index.html" class="md:hidden mb-4 inline-block">
                            <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="mx-auto h-16">
                        </a>
                        <h2 class="text-3xl font-bold text-[#3c6a99]">Login do Aluno</h2>
                        <p class="text-slate-500 mt-2">Que bom te ver de volta!</p>
                    </div>
                    
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="email" class="block text-slate-600 text-sm font-semibold mb-2">Email:</label>
                            <div class="relative flex items-center form-input border border-slate-300 rounded-lg transition">
                                <span class="absolute left-4 text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                </span>
                                <input type="email" id="email" required class="w-full pl-12 pr-4 py-3 bg-transparent rounded-lg outline-none" placeholder="seu.email@exemplo.com">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="senha" class="block text-slate-600 text-sm font-semibold mb-2">Senha:</label>
                            <div class="relative flex items-center form-input border border-slate-300 rounded-lg transition">
                                <span class="absolute left-4 text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                                </span>
                                <input type="password" id="senha" required class="w-full pl-12 pr-12 py-3 bg-transparent rounded-lg outline-none" placeholder="********">
                                <button type="button" id="toggle-password" class="absolute right-4 text-slate-500 hover:text-[#3c6a99]">
                                    <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                    <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.303 3.707A9.963 9.963 0 00.458 10c1.274 4.057 5.022 7 9.542 7 1.126 0 2.207-.245 3.232-.697z" /></svg>
                                </button>
                            </div>
                        </div>

                        <p id="message-area" class="text-red-500 text-center text-sm mb-4 h-5" aria-live="polite"></p>

                        <button type="submit" id="submit-btn" class="w-full bg-[#3c6a99] hover:bg-[#5689b9] text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg disabled:bg-slate-400 disabled:cursor-wait flex justify-center items-center">
                            <span class="btn-text">Entrar</span>
                            <svg class="animate-spin h-5 w-5 text-white ml-3 hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </form>
                    <p class="text-center text-slate-500 mt-8 text-sm">
                        Ainda não tem uma conta?
                        <a href="./cadastro.html" class="font-semibold text-[#3c6a99] hover:text-[#5689b9] hover:underline">
                            Cadastre-se agora
                        </a>
                    </p>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-[#3c6a99] text-white mt-auto">
        <div class="container mx-auto py-10 px-6 text-center">
             <img src="../static/img/ortofix.png" alt="OrtoFix Logo" class="h-12 mx-auto mb-4" style="filter: brightness(0) invert(1);">
            <p class="mb-4">Transformando o aprendizado da ortografia, uma palavra de cada vez.</p>
            <div class="flex justify-center space-x-6 text-sm">
                <a href="../termo.html" class="hover:underline">Termos de Uso</a>
                <a href="../privacidade.html" class="hover:underline">Política de Privacidade</a>
                <a href="../contato.html" class="hover:underline">Contato</a>
            </div>
            <p class="text-sm mt-8 text-blue-200">© 2025 OrtoFix. Todos os direitos reservados.</p>
        </div>
    </footer>   

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
    AOS.init({
        duration: 800,
        once: true,
    });
    </script>
    
    <script>
        // --- Constantes e Configurações ---
        const API_BASE = 'https://back-end-mvp-tcc.vercel.app';

        // --- Elementos do DOM ---
        const loginForm = document.getElementById('login-form');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');
        const messageArea = document.getElementById('message-area');
        const resumeSessionModal = document.getElementById('resume-session-modal');
        const resumeSessionBtnModal = document.getElementById('resume-session-btn-modal');
        const clearSessionBtnModal = document.getElementById('clear-session-btn-modal');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('senha');
        const eyeOpenIcon = document.getElementById('eye-open');
        const eyeClosedIcon = document.getElementById('eye-closed');

        // --- Funções Auxiliares ---
        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userName');
        }

        function redirectToDashboard() {
            window.location.href = 'inicio.html';
        }

        function setSubmitButtonState(isSubmitting) {
            submitBtn.disabled = isSubmitting;
            if (isSubmitting) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }

        // --- Lógica Principal ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const resp = await fetch(`${API_BASE}/api/aluno/perfil`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (resp.ok) {
                    resumeSessionModal.showModal();
                    if (loginForm) loginForm.classList.add('hidden');
                } else {
                    clearAuthData();
                    messageArea.textContent = 'Sua sessão expirou. Faça login novamente.';
                }
            } catch (err) {
                console.warn('Erro de rede ao verificar token:', err);
                clearAuthData();
                messageArea.textContent = 'Falha na conexão. Verifique sua internet.';
            }
        });

        // --- Event Listeners ---
        if (resumeSessionBtnModal) {
            resumeSessionBtnModal.addEventListener('click', redirectToDashboard);
        }

        if (clearSessionBtnModal) {
            clearSessionBtnModal.addEventListener('click', () => {
                clearAuthData();
                resumeSessionModal.close();
                if (loginForm) loginForm.classList.remove('hidden');
                document.getElementById('email')?.focus();
            });
        }
        
        if(togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                eyeOpenIcon.classList.toggle('hidden', isPassword);
                eyeClosedIcon.classList.toggle('hidden', !isPassword);
            });
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageArea.textContent = '';
                setSubmitButtonState(true);

                try {
                    const response = await fetch(`${API_BASE}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: document.getElementById('email').value,
                            senha: document.getElementById('senha').value
                        })
                    });
                    const data = await response.json();

                    if (!response.ok || data.user_role !== 'aluno') {
                        throw new Error(data.msg || 'Acesso negado ou credenciais inválidas.');
                    }

                    localStorage.setItem('authToken', data.access_token);
                    localStorage.setItem('userName', data.user_name);
                    redirectToDashboard();

                } catch (error) {
                    messageArea.textContent = error.message;
                    setSubmitButtonState(false);
                }
            });
        }
    </script>
</body>
</html>