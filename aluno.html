<!-- aluno.html (corrigido) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrtoFix - Login do Aluno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #e3ebf2; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="mb-8 text-center"><a href="../index.html"><img src="../../static/img/ortofix.png" alt="OrtoFix Logo" class="mx-auto h-20"></a></div>

    <div class="bg-white shadow-xl rounded-xl p-8 md:p-10 w-full max-w-md">
        <h2 class="text-2xl font-bold text-[#3c6a99] mb-6 text-center">Login do Aluno</h2>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-[#5689b9] text-sm font-semibold mb-2">Email:</label>
                <input type="email" id="email" required class="w-full px-4 py-2 border border-[#9aaec1] rounded-lg focus:ring-2 focus:ring-[#5689b9] outline-none text-[#3c6a99]" placeholder="aluno@email.com">
            </div>
            <div class="mb-6">
                <label for="senha" class="block text-[#5689b9] text-sm font-semibold mb-2">Senha:</label>
                <input type="password" id="senha" required class="w-full px-4 py-2 border border-[#9aaec1] rounded-lg focus:ring-2 focus:ring-[#5689b9] outline-none text-[#3c6a99]" placeholder="********">
            </div>
            <p id="message-area" class="text-red-500 text-center text-sm mb-4 h-5"></p>
            <button type="submit" id="submit-btn" class="w-full bg-[#3c6a99] hover:bg-[#5689b9] text-white font-bold py-3 px-4 rounded-lg transition">Entrar</button>
        </form>
        <p class="text-center text-[#5689b9] mt-6 text-sm">
            Não tem cadastro?
            <a href="./cadastro.html" class="text-[#3c6a99] hover:text-[#5689b9] font-semibold hover:underline">Cadastre-se</a>
        </p>
    </div>

<script>
const API_BASE = 'https://back-end-mvp-tcc.vercel.app';

// Helper: limpa token e outros dados
function clearAuthAndStay() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userName');
}

// Ao abrir a página: se já há token, vamos verificar se ele ainda é válido (chamada ao /api/aluno/perfil).
// Isso evita redirecionamentos baseados somente na presença do token.
document.addEventListener('DOMContentLoaded', async () => {
    const messageArea = document.getElementById('message-area');
    const token = localStorage.getItem('authToken');
    if (!token) return; // sem token, segue normalmente

    try {
        const resp = await fetch(`${API_BASE}/api/aluno/perfil`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (resp.ok) {
            // token válido -> redireciona para painel
            window.location.href = 'inicio.html';
            return;
        } else {
            // token inválido (401/403) -> limpa e permanece na página de login
            if (resp.status === 401 || resp.status === 403) {
                clearAuthAndStay();
                messageArea.textContent = 'Sua sessão expirou. Por favor, faça login novamente.';
            } else {
                // outros status (500 etc.) -> não remover imediatamente o token, apenas informar
                messageArea.textContent = 'Erro temporário ao verificar sessão — tente novamente em instantes.';
            }
        }
    } catch (err) {
        // Falha de rede -> não removemos o token aqui (pode ser temporário)
        console.warn('Erro ao verificar token no carregamento do login:', err);
    }
});

// Login
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const messageArea = document.getElementById('message-area');
    const submitBtn = document.getElementById('submit-btn');
    messageArea.textContent = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    try {
        const response = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('email').value,
                senha: document.getElementById('senha').value
            })
        });
        const data = await response.json();

        if (!response.ok || data.user_role !== 'aluno') {
            throw new Error(data.msg || 'Acesso negado ou credenciais inválidas.');
        }

        // Salva token e dados do usuário (padronizado: chave = "authToken")
        localStorage.setItem('authToken', data.access_token);
        localStorage.setItem('userName', data.user_name);

        // Redireciona para o painel principal
        window.location.href = 'inicio.html';

    } catch (error) {
        messageArea.textContent = error.message;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Entrar';
    }
});
</script>
</body>
</html>
